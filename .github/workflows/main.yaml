name: Build, Push Docker Image & Deploy to EC2

on:
    push:
        branches:
            - main

env:
    IMAGE_NAME: physics-tutoring-app
    DOCKERHUB_REPO: ${{ secrets.DOCKERHUB_USERNAME }}/physics-tutoring-app

jobs:
    build-and-push:
        name: Build and Push Docker Image
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Set up Docker Buildx
              uses: docker/setup-buildx-action@v2

            - name: Log in to Docker Hub
              uses: docker/login-action@v2
              with:
                  username: ${{ secrets.DOCKERHUB_USERNAME }}
                  password: ${{ secrets.DOCKERHUB_TOKEN }}

            - name: Build and Push Image to Docker Hub
              run: |
                  docker build -t $DOCKERHUB_REPO .
                  docker push $DOCKERHUB_REPO

    deploy-to-ec2:
        name: Deploy Docker Container to EC2
        runs-on: ubuntu-latest
        needs: build-and-push

        steps:
            - name: SSH and Deploy to EC2
              uses: appleboy/ssh-action@v0.1.10
              with:
                  host: ${{ secrets.EC2_PUBLIC_IP }}
                  username: ubuntu
                  key: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
                  script: |
                      # Install Docker if not present
                      if ! command -v docker &> /dev/null; then
                        sudo apt-get update
                        sudo apt-get install -y docker.io
                        sudo usermod -aG docker ubuntu
                        sudo systemctl start docker
                        sudo systemctl enable docker
                      fi
                      
                      # Stop & remove existing container
                      sudo docker rm -f physics-tutoring-app || true
                      
                      # Pull latest image and run
                      sudo docker pull ${{ secrets.DOCKERHUB_USERNAME }}/physics-tutoring-app
                      sudo docker run -d --name physics-tutoring-app -p 80:80 ${{ secrets.DOCKERHUB_USERNAME }}/physics-tutoring-app
